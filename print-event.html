<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Event - Event Planner</title>
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        /* Print-specific styles */
        @media print {
            body {
                background: white;
                margin: 0;
                padding: 10px;
            }
            
            .no-print {
                display: none !important;
            }
            
            .print-container {
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            .print-header {
                margin-bottom: 12px;
                padding-bottom: 8px;
                border-bottom: 2px solid #000;
            }
            
            .print-section {
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
            
            .three-columns {
                display: flex;
                gap: 20px;
                margin: 15px 0;
                page-break-inside: avoid;
                justify-content: center;
            }
            
            .column-item {
                flex: 0 0 200px;
                text-align: center;
                border: 1px solid #000;
                padding: 5px;
            }
            
            .column-item img,
            .column-item canvas {
                width: 200px !important;
                height: 200px !important;
                object-fit: cover;
                display: block;
                margin: 0 auto;
                border: 1px solid #000;
            }
            
            .column-placeholder {
                width: 200px !important;
                height: 200px !important;
                margin: 0 auto;
            }
            
            .print-info {
                font-size: 12px;
                line-height: 1.4;
                margin-bottom: 6px;
            }
            
            .print-title {
                font-size: 20px;
                margin-bottom: 4px;
            }
            
            .print-subtitle {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            @page {
                margin: 0.5cm;
                size: A4;
            }
        }
        
        /* Screen styles */
        @media screen {
            body {
                background: var(--bg-secondary);
                padding: 20px;
            }
            
            .print-container {
                max-width: 800px;
                margin: 0 auto;
                background: white;
                padding: 40px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
            }
            
            .print-header {
                margin-bottom: 32px;
                padding-bottom: 16px;
                border-bottom: 2px solid var(--border-gray);
            }
            
            .print-section {
                margin-bottom: 24px;
            }
            
            .three-columns {
                display: flex;
                gap: 20px;
                margin: 24px 0;
                align-items: flex-start;
                justify-content: center;
            }
            
            .column-item {
                flex: 0 0 200px;
                text-align: center;
                border: 1px solid var(--border-gray);
                border-radius: 8px;
                padding: 16px;
                background: var(--light-gray-1);
            }
            
            .column-item img,
            .column-item canvas {
                width: 200px;
                height: 200px;
                object-fit: cover;
                display: block;
                margin: 0 auto;
                border-radius: 4px;
                border: 1px solid var(--border-gray);
            }
            
            .column-placeholder {
                width: 200px;
                height: 200px;
                margin: 0 auto;
            }
        }
        
        .print-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .print-subtitle {
            font-size: 18px;
            color: var(--text-gray);
            margin-bottom: 24px;
        }
        
        .print-info {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 12px;
        }
        
        .print-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .print-description {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
            padding: 16px;
            background: var(--light-gray-1);
            border-radius: 8px;
            border: 1px solid var(--border-gray);
        }
        
        .print-actions {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid var(--border-gray);
        }
        
        .column-placeholder {
            width: 200px;
            height: 200px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="print-container">
        <div class="no-print print-actions">
            <button onclick="window.print()" class="button button-primary" style="margin-right: 12px;">Print</button>
            <button onclick="window.close()" class="button button-secondary">Close</button>
        </div>
        
        <div id="loading" style="text-align: center; padding: 40px;">
            <p>Loading event details...</p>
        </div>

        <div id="eventContent" style="display: none;">
            <div class="print-header">
                <h1 class="print-title" id="eventTitle">Event</h1>
                <p class="print-subtitle" id="eventPlanner">Event Planner</p>
            </div>

            <div id="eventDescriptionContainer" class="print-section" style="display: none;">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">Event Description</h2>
                <div id="eventDescription" class="print-description"></div>
            </div>

            <div class="print-section">
                <p class="print-info"><strong>Date & Time:</strong> <span id="eventDateTime"></span></p>
                <p class="print-info"><strong>Location:</strong> <span id="eventLocation"></span></p>
                <p class="print-info"><strong>Max Participants:</strong> <span id="eventMax"></span></p>
            </div>

            <div class="three-columns">
                <div class="column-item" id="imageColumn">
                    <div class="column-placeholder">No Image</div>
                </div>
                <div class="column-item" id="qrColumn">
                    <div class="column-placeholder">Loading QR Code...</div>
                </div>
            </div>
        </div>

        <div id="notFound" style="display: none;">
            <h1>Event Not Found</h1>
            <p>The event you're looking for doesn't exist or the link is invalid.</p>
            <a href="index.html" class="button button-primary">Return Home</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // Wait for QRCode library to be available
        function waitForQRCodeLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof QRCode !== 'undefined') {
                    resolve();
                    return;
                }

                let attempts = 0;
                const maxAttempts = 50;
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof QRCode !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('QRCode library failed to load'));
                    }
                }, 100);
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id') || urlParams.get('uuid');

        if (!eventId) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('notFound').style.display = 'block';
        } else {
            // Wait for QRCode library, then load event
            waitForQRCodeLibrary()
                .then(() => {
                    console.log('QRCode library loaded successfully');
                    loadEvent();
                })
                .catch((error) => {
                    console.error('Failed to load QRCode library:', error);
                    // Still try to load the event, just without QR code
                    loadEvent();
                });
        }

        async function generateQRCode(signupLink, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('QR code container not found:', containerId);
                return;
            }

            try {
                // Wait for QRCode library to be available
                await waitForQRCodeLibrary();

                // qrcodejs uses a different API - create QRCode instance
                container.innerHTML = ''; // Clear loading message
                const qr = new QRCode(container, {
                    text: signupLink,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.M
                });
                console.log('QR code generated successfully');
            } catch (error) {
                console.error('Error generating QR code:', error);
                container.innerHTML = '<div class="column-placeholder">QR Code Error</div>';
            }
        }

        async function loadEvent() {
            try {
                const response = await fetch(`/api/runs/${eventId}`);
                if (!response.ok) {
                    throw new Error('Event not found');
                }
                const event = await response.json();

                // Display event title
                const eventTitleElement = document.getElementById('eventTitle');
                const plannerNameElement = document.getElementById('eventPlanner');
                
                const eventTitleDisplay = event.title && typeof event.title === 'string' && event.title.trim() ? event.title.trim() : '';
                
                if (event.pacerName && typeof event.pacerName === 'string' && event.pacerName.trim()) {
                    const plannerName = event.pacerName.trim();
                    if (eventTitleDisplay) {
                        eventTitleElement.textContent = eventTitleDisplay;
                        plannerNameElement.textContent = `Hosted by ${plannerName}`;
                    } else {
                        eventTitleElement.textContent = `Event with ${plannerName}`;
                        plannerNameElement.textContent = '';
                    }
                } else {
                    if (eventTitleDisplay) {
                        eventTitleElement.textContent = eventTitleDisplay;
                    } else {
                        eventTitleElement.textContent = 'Event';
                    }
                    plannerNameElement.textContent = '';
                }

                // Display description if available
                const descriptionContainer = document.getElementById('eventDescriptionContainer');
                const descriptionText = document.getElementById('eventDescription');
                if (event.description && event.description.trim()) {
                    descriptionText.textContent = event.description.trim();
                    descriptionContainer.style.display = 'block';
                } else {
                    descriptionContainer.style.display = 'none';
                }

                // Display event details
                document.getElementById('eventLocation').textContent = event.location || '-';
                document.getElementById('eventDateTime').textContent = new Date(event.dateTime).toLocaleString();
                document.getElementById('eventMax').textContent = event.maxParticipants || '-';

                // Column 1: Event Picture
                const imageColumn = document.getElementById('imageColumn');
                if (event.picture) {
                    const img = document.createElement('img');
                    img.src = 'data:image/jpeg;base64,' + event.picture;
                    img.alt = 'Event picture';
                    img.style.width = '200px';
                    img.style.height = '200px';
                    img.style.objectFit = 'cover';
                    imageColumn.innerHTML = '';
                    imageColumn.appendChild(img);
                } else {
                    imageColumn.innerHTML = '<div class="column-placeholder">No Image</div>';
                }

                // Column 2: QR Code
                const baseUrl = window.location.origin;
                const signupLink = `${baseUrl}/signup.html?id=${event.id}`;
                
                await generateQRCode(signupLink, 'qrColumn');

                document.getElementById('loading').style.display = 'none';
                document.getElementById('eventContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading event:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('notFound').style.display = 'block';
            }
        }
    </script>
</body>
</html>
